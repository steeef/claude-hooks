name: Release

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Determine next version
        id: semver
        uses: SOLIDSoftworks/semver-tags@fa8963220fb4913aea2b20cc190004de1b79f395  # v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag-prefix: v
          default-version: 1.0.0
          incremented-value: patch
          dry-run: true

      - name: Validate version
        run: |
          VERSION="${{ steps.semver.outputs.semantic-version }}"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "Error: Invalid semver version: '$VERSION'"
            exit 1
          fi
          echo "Valid version: $VERSION"

      - name: Update version in JSON files
        run: |
          VERSION="${{ steps.semver.outputs.semantic-version }}"
          echo "Updating to version: $VERSION"

          # Update marketplace.json plugin versions
          jq --arg v "$VERSION" '(.plugins[].version) = $v' .claude-plugin/marketplace.json > tmp.json && mv tmp.json .claude-plugin/marketplace.json

          # Update each plugin's plugin.json
          for plugin_dir in plugins/*/; do
            plugin_json="${plugin_dir}.claude-plugin/plugin.json"
            if [ -f "$plugin_json" ]; then
              jq --arg v "$VERSION" '.version = $v' "$plugin_json" > tmp.json && mv tmp.json "$plugin_json"
            fi
          done

      - name: Commit version bump
        run: |
          VERSION="${{ steps.semver.outputs.semantic-version }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add -A
          git diff --staged --quiet || git commit -m "chore: bump version to $VERSION"
          git push

      - name: Create tag and release
        uses: SOLIDSoftworks/semver-tags@fa8963220fb4913aea2b20cc190004de1b79f395  # v1
        with:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          tag-prefix: v
          default-version: 1.0.0
          incremented-value: patch
          create-release: true
